package nju.edu.cn.evaluation;
//import java.awt.Label;
import java.util.ArrayList;
import java.util.List;

import Util.FileUtil;
import nju.edu.cn.label.AspectItem;
import nju.edu.cn.label.LabelItem;
import nju.edu.cn.prediction.TaxonomyModel;
public class Test {
	List<LabelItem> readTestCorpusFile(String file)
	{
		List<String> lines = FileUtil.loadSentence(file);
		List<LabelItem> goldCourpus = new ArrayList<LabelItem>();
		//i == 0 label
		for(int i = 1; i < lines.size();i++)
		{
			String line = lines.get(i);
			if(line.trim().equals(""))
			{
				continue;
			}

			if(!line.startsWith("{")||!line.startsWith("}"))
			{
				LabelItem item = new LabelItem(line.trim());
				i++;
				while(i < lines.size() && lines.get(i).startsWith("{") && lines.get(i).endsWith("}"))
				{
					line = lines.get(i++);
					String[] golds = line.substring(1, line.length()-1).split(",");
					if(golds.length != 6){System.out.println("gold corpus marked error!");continue;}
					AspectItem aspectItem = new AspectItem();
					//aspect category
					aspectItem.setAspectCategory(golds[0].split("#")[1].equals("NULL") ? null : golds[0].split("#")[1]);
					//asepct word
					aspectItem.setAspectWord(golds[1].equals("NULL") ? null : golds[1]);
					//reveiw 
					aspectItem.setReview(golds[2].equals("NULL") ? null : golds[2]);
					//review polarity
					if(golds[3].equals("NULL"))
					{
						aspectItem.setReviewPolarity(0);
					}else
						aspectItem.setReviewPolarity(golds[3].equals("positive")?1:golds[3].equals("netural")?0:-1);
					//attitude
					aspectItem.setAttitude(golds[4].equals("NULL") ? null : golds[4]);
					//attitude polarity
					if(golds[5].equals("NULL"))
					{
						aspectItem.setAttitudePolarity(0);
					}else
						aspectItem.setAttitudePolarity(golds[5].equals("positive")?1:golds[5].equals("netural")?0:-1);
					item.addAspectWord(aspectItem);
				}
				goldCourpus.add(item);
			}
		}
		return goldCourpus;
	}
	float[] getPrecise(List<byte[]> matrix)
	{
		//1:right 
		//0:wrong 
		//-1: gold null
		//-2:predict null
		//-3: gold null predict null
		int m = matrix.get(0).length,n = matrix.size();
		float[] precises = new float[m];
		for(int i = 0;i<m;i++)
		{
			int rightCount = 0;
			int count = 0;
			for(int j = 0;j < n;j++)
			{
				if(matrix.get(j)[i] != -2 && matrix.get(j)[i] != -3)
				{
					count++;
				}
				if(matrix.get(j)[i] == 1)
				{
					rightCount++;
				}
			}
			precises[i] = (float) (rightCount*1.0/count);
		}
		return precises;
	}
	
	float[] getRecall(List<byte[]> matrix)
	{
		int m = matrix.get(0).length,n = matrix.size();
		float[] recalls = new float[m];
		for(int i = 0;i<m;i++)
		{
			int rightCount = 0;
			int count = 0;
			for(int j = 0;j < n;j++)
			{
				if(matrix.get(j)[i] != -1 && matrix.get(j)[i] !=-3)
				{
					count++;
				}
				if(matrix.get(j)[i] == 1)
				{
					rightCount++;
				}
			}
			recalls[i] = (float) (rightCount*1.0/count);
		}
		return recalls;
		
	}
	/**
	 * 暂时只评估一个句子只有一种结果的情况 
	 * @param taxModel
	 */
	void evaluate(TaxonomyModel taxModel)
	{
		List<LabelItem> testCorpus = readTestCorpusFile("test_corpus");
		System.out.println(testCorpus.size());
		int matrixLen = 0;
		List<byte[]> preciseMatrix = new ArrayList<>();
		List<byte[]> recallMatrix = new ArrayList<>();
		List<byte[]> matrix = new ArrayList<>();
		for(int i = 0; i < testCorpus.size(); i++)
		{
			LabelItem goldItem = testCorpus.get(i);
			LabelItem predictItem = new LabelItem(goldItem.sentence);
			taxModel.predict(predictItem);
			if(goldItem.getAspectListSize() == 1 && predictItem.getAspectListSize() == 1)
			{
				//所有结果{entity#aspectCategory,aspectWord,review,ploarity,attitude,ploarity}
				AspectItem goldAspect = goldItem.aspectList.get(0);
				AspectItem predictAspect = predictItem.aspectList.get(0);
				System.out.println(goldItem.sentence);
				System.out.println(goldAspect.toString());
				System.out.println(predictAspect.toString());
				String[] goldLabels = new String[]{goldAspect.getAspectCategory(),goldAspect.getAspectWord(),
							goldAspect.getReview(),String.valueOf(goldAspect.getReviewPolarity()),
							goldAspect.getAttitude(),String.valueOf(goldAspect.getAttitudePolarity())};

				String[] predictLabels = new String[]{predictAspect.getAspectCategory(),predictAspect.getAspectWord(),
						predictAspect.getReview(),String.valueOf(predictAspect.getReviewPolarity()),
						predictAspect.getAttitude(),String.valueOf(predictAspect.getAttitudePolarity())};
				byte[] vec = new byte[6];
				for(int j = 0; j < 6; j++)
				{
					if(goldLabels[j] != null && predictLabels[j] != null)
					{
						if(goldLabels[j].equals(predictLabels[j]))
						{
							vec[j] = 1;
						}else
							vec[j] = 0;
					}else
					if(goldLabels[j] == null && predictLabels[j] == null)
					{
						vec[j] = -3;
					}else
					if(goldLabels[j] == null)
					{
						vec[j] = -1;
					}else
						vec[j] = -2;
					
				}
				matrix.add(vec);
			}
			
			

			//precise right / allpredict

		}
		float[] precises = getPrecise(matrix);
		for(float p : precises)
		{
			System.out.print(p+"\t");
		}
		System.out.println();
		float[] recalls = getRecall(matrix);
		for(float r : recalls)
		{
			System.out.print(r+"\t");
		}
	}
	void evaluateForReviewWordAccurayWhenAspectwordIsCorrect(TaxonomyModel taxModel)
	{
		List<LabelItem> testCorpus = readTestCorpusFile("test_corpus");
		System.out.println(testCorpus.size());
		int matrixLen = 0;
		List<byte[]> preciseMatrix = new ArrayList<>();
		List<byte[]> recallMatrix = new ArrayList<>();
		List<byte[]> matrix = new ArrayList<>();
		for(int i = 0; i < testCorpus.size(); i++)
		{
			System.out.println();
			LabelItem goldItem = testCorpus.get(i);
			LabelItem predictItem = new LabelItem(goldItem.sentence);
			for(AspectItem aspect : goldItem.aspectList)
			{
				predictItem.addAspectWord(new AspectItem(aspect.getAspectWord(), null, 0));
			}
			taxModel.predictWhenApsectWordIsCorrect(predictItem);
			if(goldItem.getAspectListSize() == 1 && predictItem.getAspectListSize() == 1)
			{
				//所有结果{entity#aspectCategory,aspectWord,review,ploarity,attitude,ploarity}
				AspectItem goldAspect = goldItem.aspectList.get(0);
				AspectItem predictAspect = predictItem.aspectList.get(0);
//				System.out.println(goldItem.sentence);
//				System.out.println(goldAspect.toString());
//				System.out.println(predictAspect.toString());
				String[] goldLabels = new String[]{goldAspect.getAspectCategory(),goldAspect.getAspectWord(),
							goldAspect.getReview(),String.valueOf(goldAspect.getReviewPolarity()),
							goldAspect.getAttitude(),String.valueOf(goldAspect.getAttitudePolarity())};

				String[] predictLabels = new String[]{predictAspect.getAspectCategory(),predictAspect.getAspectWord(),
						predictAspect.getReview(),String.valueOf(predictAspect.getReviewPolarity()),
						predictAspect.getAttitude(),String.valueOf(predictAspect.getAttitudePolarity())};
				byte[] vec = new byte[6];
				for(int j = 0; j < 6; j++)
				{
					if(goldLabels[j] != null && predictLabels[j] != null)
					{
						if(goldLabels[j].equals(predictLabels[j]))
						{
							vec[j] = 1;
						}else
							vec[j] = 0;
					}else
					if(goldLabels[j] == null && predictLabels[j] == null)
					{
						vec[j] = -3;
					}else
					if(goldLabels[j] == null)
					{
						vec[j] = -1;
					}else
						vec[j] = -2;
					
				}
				matrix.add(vec);
			}
			
			

			//precise right / allpredict

		}
		float[] precises = getPrecise(matrix);
		for(float p : precises)
		{
			System.out.print(p+"\t");
		}
		System.out.println();
		float[] recalls = getRecall(matrix);
		for(float r : recalls)
		{
			System.out.print(r+"\t");
		}
	}
	public static void main(String[] args) {
		// TODO Auto-generated method stub
		TaxonomyModel taxModel = new TaxonomyModel();
		taxModel.learnModel();
		Test test = new Test();
		test.evaluate(taxModel);;
	}////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}
